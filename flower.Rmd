---
title: "EXST 7142 Project"
author: "Yiou Dai   (2023-11-07)"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse, warn.conflicts = F)
library(sf)
library(olsrr)
library(car)
library(ggplot2)
all_envi_25km = readRDS("d.rds") #%>% 
  #dplyr::filter(sp == "Claytonia virginica") %>%
  #distinct()
```

1. Introduction

It is well known that plants in warmer areas such as those with lower latitudes and altitudes have earlier starting dates for leaf-out and flowering, a pattern referred to as the Hopkins' Bio climatic Law [@hopkins1920bioclimatic]. However, this pattern has not been quantified for a large number of species. We thus are not sure how general this pattern is. Yet, understanding this pattern is critical because the production of leaves and flowers provides critical resources and cues to other species such as insects [@kudo2013early; @schenk2018bees], thereby directly impacting plant fitness and ecosystem health [@petanidou2014variable; @rafferty2016later]. It is also critical for predicting the effects of future climate and land-use change on plants, pollinators, and herbivores [@petanidou2014variable]. Here, in this project, I will use linear regression model to investigate whether it is general that plants in warmer areas flower earlier than those in colder areas; and if so, what is the relationship between flowering time and temperature. Then, I will use non-parametric methods such as bagging tree and random forest models to predict the flowering time and compare which model performs the best. 

2. Dataset description 

The dataset is generated by @li2021climate, who scored 160,097 images with flowers that were taken between 2017 to 2019 within the mainland of the United States for 52 widely distributed plant species. Each images was scored to confirm the presence of flowers. Information such as date, location, and species names were also extracted. The mainland of US was divided into 25 km by 25 km grid cells. Within each grid cell, the flowering onset date was estimated using the scored images and its average temperature between 1980 to 2010 was extracted from the PRISM program [@prismData2004].

```{r}
as.data.frame(head(all_envi_25km, n = 1))
dim(all_envi_25km)
```

The original flower dataset contains 2281 observations and 29 measurements. Since flowering time is crucial for plants, pollinators, herbivores and all other aspects of ecosystem health, I want to know what factors influence the flowering time the most. Based on previous researches, the flowering onset date of a plant species can be influenced by a variety of factors, including environmental, genetic, and physiological factors. Here, I use flower onset day as the response variable, and the input variables are temperature, precipitation, elevation, seasonal changes, human population density etc.  


```{r}
#| echo: true
#| message: false
if(!require("xfun")) install.packages("xfun")
xfun::pkg_attach2(c("tidyverse", "sf", "kableExtra", "broom"))
df <- all_envi_25km %>% 
  select(onset, temp = bio_1, prep = bio_12, prepv = bio_15, elev, seas = bio_4, lpop = pop_25km_log, lat, long, nchi = n_chilling_days_winter, offset, sp) %>% 
  st_drop_geometry(df)
write_csv(df, "/Users/ydai/Downloads/EXST7142/Project/df.csv")
```


- `onset`: the estimated onset of flowering in day of the year
- `temp`: annual average temperature (°C) of the grid cell from 1980-2010
- `prep`: annual precipitation of the grid cell boundary 
- `prepv`: precipitation variability of the grid cell boundary
- `elev`: the average elevation (m) of the grid cell
- `seas`: seasonality of the grid cell boundary 
- `lpop`: the log of human population density of the grid cell boundary
- `lat`: the latitude of the grid cell boundary 
- `long`: the longitude of the grid cell boundary
- `nchi`: the number of chilling days in winter of the grid cell boundary 
- `offset`: the offset of flowering in day of the year 
- `sp`: the scientific name to uniquely identify a particular plant species (categorical variable)
- `geometry`: the latitude/longitude coordination of the grid cell boundary 

The distribution of grid cells with enough data to estimate flowering onset date.

```{r message=FALSE}
plt_base = readRDS("plt_base.rds")
plt_map = plt_base +
  geom_sf(data = unique(dplyr::select(all_envi_25km, id_cells)),
          fill = "magenta") +
  theme_minimal(base_size = 15) +
  coord_sf(expand = F)
plt_map
```

When do most of these species flower? The average days of flowering is 112 days, which means the timing of flowering onset in plant are mostly in the spring, specifically it is between March and April. The earliest flowering day is the 7th day in a new year, and the last flowering day is the 278th day. The plot below has two distinct peaks or modes. I will analysis it later. 

```{r}
summary(all_envi_25km$onset)
ggplot(all_envi_25km, aes(x = onset)) +
  geom_histogram() +
  labs(x = "Figure1. Flower onset date (Julian day)")
```

This flowering time can vary significantly depending on the species, we have 55 plant species here, and the most common species are Impatiens capensis (178 observations), Dichelostemma capitatum (141 observations), and Claytonia virginica (138 observations). One of the purpose in this study is to compare the onset of flowering in days of the year between these 3 species, so we subset using these 3 species: IC (Impatiens capensis), DC (Dichelostemma capitatum) and CV (Claytonia virginica). 

```{r}
table(df$sp)
df1 <- df %>% 
  filter(sp %in% c("Impatiens capensis", "Dichelostemma capitatum", "Claytonia virginica"))
```


```{r}
#| echo: false
knitr::kable(as.data.frame(head(df1, n = 5)), booktabs = T) |> 
 kableExtra::kable_styling(bootstrap_options = c("striped", "scale_down", "condensed", "hover"), 
              latex_options = c("striped", "scale_down"))
```

The histograms below show that the peak for species CV and DC are 100 days, but the peak for IC is 200 days, that explains why in the Figure 1. the distribution for all species is a Bimodal Distribution. 

```{r}
ggplot(df1, aes(x = onset, fill = sp)) +
  geom_histogram(binwidth = 10, position = "stack", color = "black") +
  labs(x = "Flower onset date (Julian day)", y = "Frequency") +
  ggtitle("Figure2. Distribution of Flower Onset Dates by Species") +
  theme_minimal() +
  facet_wrap(~sp)
```

```{r}
summary(df1)
par(mfrow=c(4,3),mar=c(4,4,2,2))
hist(df1$temp, main = "histogram of temp", xlab = "temp", ylab = "Frequency")
hist(df1$prep, main = "histogram of prep", xlab = "prep", ylab = "Frequency")
hist(df1$prepv, main = "histogram of prepv", xlab = "prepv", ylab = "Frequency")
hist(df1$elev, main = "histogram of elev", xlab = "elev", ylab = "Frequency")
hist(df1$seas, main = "histogram of seas", xlab = "seas", ylab = "Frequency")
hist(df1$lpop, main = "histogram of lpop", xlab = "lpop", ylab = "Frequency")
hist(df1$lat, main = "histogram of lat", xlab = "lat", ylab = "Frequency")
hist(df1$long, main = "histogram of long", xlab = "long", ylab = "Frequency")
hist(df1$nchi, main = "histogram of nchi", xlab = "nchi", ylab = "Frequency")
hist(df1$offset, main = "histogram of offset", xlab = "offset", ylab = "Frequency")
```


3. Statistical Methods

For all 3 species, the estimated flowering onset dates seem to be consistent across years. I therefore lumped data from all years together for the species within each grid cell.

1. Linear regression model 

To investigate the impacts of predictors on flowering time, I used linear regression model first. linear regression model has the following form:
$$Y = \beta_0 + \beta_i \times X_i + \epsilon$$

where the predictor variables $Xi$ are annual average temperature (°C), latitude, longitude, elevation, population in the city, number of chilling days in the city,  mean temperature in the winter, precipitation variation...all list above; the response variable ($Y$) is the estimated flowering onset date (day of the year `onset`); $\epsilon$ is the error term and assumed to follow iid (independent identical distribution) $Normal(0, \sigma^2)$.

Randomly split the dataset into training and test sets. Here I use 80% to  train the data and the rest 20% to test the model. 

```{r}
N = nrow(df1)
set.seed(1) #set random seed reproducible
indx <- sample(1:N,size = N,replace = F)
df1.train <- df1[indx[1:366],] # 80% to be training data 
df1.test <- df1[indx[367:N],]
```

Fit a linear model, MSE = `r mean((lm.pred.test - df1.test$onset)^2)` 

```{r}
lm.fit <- lm(onset ~., data = df1.train)
lm.pred.test <- predict(lm.fit, newdata = df1.test)
mean((lm.pred.test - df1.test$onset)^2) # MSE = 420.038
```


2. Random Forest 

The default setting in randomForest was used to fit the training samples. The option `r keep.forest=TRUE` is necessary to predict on new dataset and plot partial dependent function. 

```{r}
## Run RF using default settings
library(randomForest)
set.seed(1) #set random seed to make the results reproducible
fit1 <- randomForest(onset ~ ., data=df1.train, xtest=df1.test[,-1], ytest=df1.test$onset, ntree = 500, keep.forest=TRUE)
fit1
```

The default value for ntree is 500. The MSE on the OOB samples is about 343 and R-square is about 91%. The MSE and R-square on the test samples are around 381 and 90%. If we use all the trees to predict the train samples, the MSE and R-square will be different. 

```{r}
## Predict on the training samples using all trees
pred.train <- predict(fit1,df1.train)
mean((pred.train-df1.train$onset)^2) #MSE using all trees
1-sum((pred.train-df1.train$onset)^2)/(399*var(df1.train$onset)) #R-square using all trees

## Plot MSE on OOB samples 
plot(fit1, main="MSE on OOB samples")
```

3. Bagging trees:

```{r}

```


```{r}
## Bagging tree with mtry=p
set.seed(1) 
fit2 <- randomForest(onset~.,data=df1.train, xtest=df1.test[,-4], ytest=df1.test$onset,mtry=3)
fit2

## Show relative variable importance in RF
importance(fit1)
varImpPlot(fit1, sort=TRUE)

## Plot partial dependence plots for the two most important variables
par(mfrow=c(1,2))
partialPlot(fit1, df1.train, 'offset')
partialPlot(fit1, df1.train, 'temp')

## Show the improvement of averaging individual trees in RF
pred.test <- predict(fit1,df.test,predict.all=T)
FUN <- function(x){
  mean((x-df.test$onset)^2)
}
par(mfrow=c(1,1))
hist(apply(pred.test$temp,2,FUN),xlim=c(0,100),xlab="MSE on test set",
     main="Histogram of MSE on individual trees from RF")
abline(v=8.4,col="red")
```


4. Conclusion

Based on separate simple linear regression models, the majority (30 out of 46, or 65%) of plant species investigated here supported the idea that plants in warmer areas will flower earlier. On average, with 1 °C increase in annual temperature, plants tend to flower about `r mean(slopes_sig)` days earlier. Surprisingly, there are 16 out of 46 (or 35%) species did not follow the Hopkins' Bio climatic rule (@fig-slopes-non-sig), suggesting that either we lack enough data for these species or the Hopkins' Bio climatic rule may not hold for every species. Overall, our results suggested that the Hopkins' Bio climatic rule holds for the majority of plant species. However, we need be cautious when using this rule to predict flowering time of individual species.






# Reference
